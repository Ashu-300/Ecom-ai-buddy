# ============================================================
# NGINX API Gateway Configuration for Localhost Microservices
# with Automatic Fallback to Monolith (except aibuddyService)
# ============================================================

# -------------------- Upstream blocks --------------------
upstream auth_backend {
    server 127.0.0.1:30081;
}

upstream cart_backend {
    server 127.0.0.1:30082;
}

upstream product_backend {
    server 127.0.0.1:30083;
}

upstream order_backend {
    server 127.0.0.1:30084;
}

upstream payment_backend {
    server 127.0.0.1:30085;
}

upstream aibuddy_backend {
    server 127.0.0.1:30086;
}

upstream email_backend {
    server 127.0.0.1:30087;
}

upstream seller_backend {
    server 127.0.0.1:30088;
}

upstream monolith_backend {
    server 127.0.0.1:30080;
}


# -------------------- Server Configuration --------------------
server {
    listen 80;
    server_name localhost;

    # =========================================================
    # Common proxy headers
    # =========================================================
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # =========================================================
    # Auth Service with Monolith Fallback
    # =========================================================
    location /api/auth/ {
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://auth_backend;
        error_page 502 503 504 = @monolith_fallback;
    }

    # =========================================================
    # Cart Service with Monolith Fallback
    # =========================================================
    location /api/cart/ {
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://cart_backend;
        error_page 502 503 504 = @monolith_fallback;
    }

    # =========================================================
    # Product Service with Monolith Fallback
    # =========================================================
    location /api/product/ {
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://product_backend;
        error_page 502 503 504 = @monolith_fallback;
    }

    # =========================================================
    # Order Service with Monolith Fallback
    # =========================================================
    location /api/order/ {
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://order_backend;
        error_page 502 503 504 = @monolith_fallback;
    }

    # =========================================================
    # Payment Service with Monolith Fallback
    # =========================================================
    location /api/payment/ {
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://payment_backend;
        error_page 502 503 504 = @monolith_fallback;
    }

    # =========================================================
    # Email Service with Monolith Fallback
    # =========================================================
    location /api/email/ {
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://email_backend;
        error_page 502 503 504 = @monolith_fallback;
    }

    # =========================================================
    # Seller Dashboard Service with Monolith Fallback
    # =========================================================
    location /api/seller-dashboard/ {
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://seller_backend;
        error_page 502 503 504 = @monolith_fallback;
    }

    # =========================================================
    # AI Buddy Service — No Fallback
    # =========================================================
    location /api/aibuddy/ {
        proxy_pass http://aibuddy_backend;
    }

    # =========================================================
    # Monolith Fallback Route (handles fallback requests)
    # =========================================================
    location @monolith_fallback {
        proxy_pass http://monolith_backend;
    }

    # =========================================================
    # Default Fallback — Root or Unmatched Paths
    # =========================================================
    location / {
        proxy_pass http://monolith_backend;
    }
}
